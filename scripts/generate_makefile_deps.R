#!/usr/bin/env RScript

# generate the dependencies of the PEcAn packages on each other.

#checkthis <- c('Depends', 'Imports', 'Remotes')
checkthis <- c('Depends', 'Imports', 'Remotes', 'Suggests')

files <-
  c(
    list.files(
      path = "base",
      full.names = TRUE,
      pattern = "^DESCRIPTION$",
      recursive = TRUE
    ),
    list.files(
      path = "modules",
      full.names = TRUE,
      pattern = "^DESCRIPTION$",
      recursive = TRUE
    ),
    list.files(
      path = "models",
      full.names = TRUE,
      pattern = "^DESCRIPTION$",
      recursive = TRUE
    )
  )

## Required dependencies
pecan <- c()
depends <- c()
d <- purrr::walk(files,
                 function(x) {
                   y <- desc::desc_get_deps(x)
                   y <- y[y$type %in% checkthis, 'package']
                   y <- y[grepl('^PEcAn.', y)]
                   p <- desc::desc_get_field('Package', file=x)
                   f <- gsub('/DESCRIPTION$', '', x)
                   pecan[[p]] <<- f
                   depends[[f]] <<- y
                 } )

cat('# autogenerated', file = 'Makefile.depends', sep = '\n', append = FALSE)
for (name in names(depends)) {
  if (name == 'models/template') next
  x <- paste0('$(call depends,', name, '): |')
  for (p in depends[[name]]) {
    # TEMP HACK: Don't declare known circular deps in utils Suggests
    if (name == "base/utils" && p == "PEcAn.DB") next
    if (name == "base/utils" && p == "PEcAn.settings") next
    if (name == "base/utils" && p == "PEcAn.data.atmosphere") next
    if (name == "base/utils" && p == "PEcAn.data.land") next
    x <- paste0(x, ' .install/', pecan[[p]])
  }
  cat(x, file = 'Makefile.depends', sep = '\n', append = TRUE)
}
